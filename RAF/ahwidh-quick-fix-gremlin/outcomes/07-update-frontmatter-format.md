# Outcome: Update plan frontmatter to standard Obsidian format

## Summary
Successfully migrated plan file frontmatter from the non-standard closing-delimiter-only format to the standard Obsidian/YAML format with both opening and closing `---` delimiters. The parser maintains full backward compatibility with existing plan files.

## Changes Made

### 1. Updated `src/utils/frontmatter.ts`

**Enhanced `parsePlanFrontmatter()` function** (lines 27-72):
- **Before**: Only supported legacy format (closing `---` only)
- **After**: Supports both standard format (`---`/`---`) and legacy format for backward compatibility

**Standard format detection** (lines 50-62):
- Checks if content starts with `---` (after trimming leading whitespace)
- If present: extracts content between opening `---` and closing `---`
- Handles `---` with trailing spaces/content on the same line
- Returns empty if no closing delimiter found

**Legacy format fallback** (lines 63-69):
- If no opening `---` found: uses original logic
- Finds first `---` and treats everything before it as frontmatter
- Maintains 100% compatibility with existing plan files

**Updated JSDoc** (lines 26-47):
- Documents both supported formats with examples
- Clarifies standard format is preferred

### 2. Updated `tests/unit/frontmatter.test.ts`

**Added comprehensive standard format tests** (lines 4-96):
- Parse effort field in standard format
- Parse model field in standard format
- Parse both effort and model
- Handle empty frontmatter block (`---\n---`)
- Handle whitespace before opening delimiter
- Handle empty lines in frontmatter
- Handle opening delimiter with trailing spaces
- Return empty for missing closing delimiter
- Return empty for opening delimiter without newline

**Renamed legacy tests section** (line 98):
- Changed from `'valid frontmatter'` to `'legacy format (closing --- only)'`
- All existing tests remain unchanged and passing

**Test results**:
- All 26 frontmatter tests pass (9 new standard format tests, 16 legacy format tests, 1 renamed)
- Full test suite: 1299 tests pass (no regressions)

### 3. Updated `src/prompts/planning.ts`

**Updated frontmatter format instructions** (lines 83-88):
- Changed example from closing-only to standard format with opening `---`
- Updated description: "The frontmatter uses standard YAML format with opening and closing \`---\` delimiters"

**Updated frontmatter optional model example** (lines 129-136):
- Added opening `---` to the example showing model override

### 4. Updated `src/prompts/amend.ts`

**Updated frontmatter format instructions** (lines 138-143):
- Changed example from closing-only to standard format with opening `---`
- Updated description: "The frontmatter uses standard YAML format with opening and closing \`---\` delimiters"

**Updated frontmatter optional model example** (lines 188-195):
- Added opening `---` to the example showing model override

### 5. Updated `CLAUDE.md`

**Updated Plan File Structure section** (lines 47-84):
- Changed frontmatter example from closing-only to standard format
- Updated frontmatter description:
  - Before: "Uses Obsidian-style format: \`key: value\` lines followed by \`---\` (no opening delimiter)"
  - After: "Uses standard Obsidian/YAML format: opening \`---\`, \`key: value\` lines, closing \`---\`"
- Added note: "Parser also supports legacy format (no opening \`---\`) for backward compatibility"

### 6. Updated current project plan file

**Updated task 07 plan file** (`RAF/ahwidh-quick-fix-gremlin/plans/07-update-frontmatter-format.md`):
- Changed from `effort: medium\n---` to `---\neffort: medium\n---`
- Demonstrates the new standard format in action

## Key Features

1. **Standard compliance**: Aligns with Obsidian, Jekyll, Hugo, and other markdown tools
2. **Backward compatibility**: All existing plan files with legacy format continue to work
3. **Robust parsing**: Handles whitespace variations, empty blocks, and edge cases
4. **Future-proof**: New plan files generated by Claude will use the standard format
5. **Comprehensive testing**: 9 new tests for standard format, all legacy tests preserved

## Acceptance Criteria

- ✅ Parser handles standard `---`/`---` format correctly
- ✅ Parser still handles legacy closing-only format (backward compatibility)
- ✅ Planning prompts generate the new standard format
- ✅ CLAUDE.md documentation updated
- ✅ Tests cover both old and new formats
- ✅ All existing tests pass (1299/1299)

## Notes

- The parser uses `trimStart()` to handle optional leading whitespace before the opening `---`
- The standard format requires a newline after the opening `---` (cannot be `---key: value`)
- Legacy format is automatically detected when content doesn't start with `---`
- All future plan files generated by Claude will use the standard format with opening delimiter

<promise>COMPLETE</promise>
