# Task: Implement Failure Analysis with Sonnet

## Objective
When a task fails, use Sonnet to analyze the execution output and generate a structured failure report.

## Context
For failed tasks, RAF should create the outcome file (not Claude, since Claude may not have completed). The failure outcome should contain a structured analysis of what went wrong, generated by Sonnet analyzing the task output.

## Requirements
- On task failure, call Sonnet to analyze execution output
- Generate structured report with sections:
  - `## Failure Reason` - Brief description
  - `## Analysis` - What went wrong and why
  - `## Suggested Fix` - How to resolve the issue
  - `## Relevant Output` - Key parts of the output
- End with `<promise>FAILED</promise>` marker
- Handle special cases programmatically (no Sonnet call needed):
  - API errors
  - Rate limit errors
  - Timeout errors
  - Context overflow

## Implementation Steps
1. Create new module `src/core/failure-analyzer.ts`:
   - `analyzeFailure(output: string, failureReason: string): Promise<string>`
   - Uses Sonnet model via ClaudeRunner or direct API call
   - Returns formatted failure report
2. Add helper to detect special error cases
3. Create templates for programmatic failure outcomes
4. Update `do.ts` failure handling to use analyzer
5. Add tests for failure analysis

## Acceptance Criteria
- [ ] Sonnet analyzes failures and generates structured report
- [ ] API/limit/timeout errors handled programmatically (no API call)
- [ ] Failure outcome ends with `<promise>FAILED</promise>`
- [ ] Report includes all required sections
- [ ] Tests cover both Sonnet analysis and programmatic cases

## Notes
- Use haiku or fast model variant for cost efficiency if available
- Keep analysis prompt concise to minimize tokens
- Timeout the analysis call to avoid hanging on API issues
- This task depends on Task 002 (state derivation) and Task 003 (do.ts changes)
